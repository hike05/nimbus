# Спецификация: Рефакторинг и автоматизация развертывания

## Цель
Создать чистую, минималистичную кодовую базу с полностью автоматическим развертыванием без ручного вмешательства.

## Проблемы, выявленные при тестировании

### 1. Терминология
- ❌ Упоминания "VPN" в коде и конфигах
- ❌ Префиксы "stealth-" в именах контейнеров
- ❌ Явные названия протоколов в путях и переменных

### 2. Конфигурация
- ❌ Требуется ручное создание пользователя через админ-панель
- ❌ Конфигурации VPN не генерируются автоматически
- ❌ Проблемы с bcrypt хешами в .env файле
- ❌ CPU limits не адаптируются под сервер
- ❌ User permissions вызывают ошибки

### 3. Развертывание
- ❌ Многошаговый процесс с ручными правками
- ❌ Сертификаты копируются вручную
- ❌ Контейнеры запускаются с ошибками
- ❌ Нет автоматической проверки готовности

### 4. Кодовая база
- ❌ Много неиспользуемого кода
- ❌ Дублирование функционала
- ❌ Избыточная документация
- ❌ Тестовые скрипты в продакшене

## Требования

### Функциональные

1. **Автоматическое развертывание**
   - Одна команда `./install.sh` должна полностью настроить систему
   - Автоматическое создание первого пользователя
   - Автоматическая генерация всех конфигураций
   - Автоматическая настройка SSL

2. **Нейтральная терминология**
   - Заменить "VPN" на "proxy" или "service"
   - Убрать "stealth-" префиксы
   - Использовать общие названия (app, web, api)

3. **Минимальная кодовая база**
   - Удалить неиспользуемые скрипты
   - Удалить тестовые файлы
   - Удалить избыточную документацию
   - Оставить только необходимый функционал

4. **Надежность**
   - Автоматическое определение CPU/RAM
   - Корректная обработка прав доступа
   - Graceful degradation при ошибках
   - Автоматический откат при проблемах

### Нефункциональные

1. **Простота**
   - Минимум зависимостей
   - Понятная структура
   - Самодокументируемый код

2. **Безопасность**
   - Нет явных упоминаний назначения
   - Обфускация конфигураций
   - Безопасное хранение паролей

3. **Производительность**
   - Быстрое развертывание (<5 минут)
   - Минимальное использование ресурсов
   - Оптимизированные Docker образы

## Архитектура решения

### Новая структура проекта

```
nimbus/
├── install.sh              # Единственный скрипт установки
├── docker-compose.yml      # Упрощенная конфигурация
├── .env.example           # Шаблон с автозаполнением
├── config/
│   └── Caddyfile          # Минимальная конфигурация
├── services/
│   ├── web/               # Админ-панель (было admin-panel)
│   ├── proxy-a/           # Xray (нейтральное название)
│   ├── proxy-b/           # Trojan
│   ├── proxy-c/           # Sing-box
│   └── proxy-d/           # WireGuard
├── core/                  # Только необходимые модули
│   ├── config.py          # Генерация конфигураций
│   ├── user.py            # Управление пользователями
│   └── setup.py           # Автоматическая настройка
└── data/                  # Runtime данные (создается автоматически)
```

### Упрощенные имена контейнеров

```
nimbus-web       # Админ-панель
nimbus-gateway   # Caddy
nimbus-proxy-a   # Xray
nimbus-proxy-b   # Trojan
nimbus-proxy-c   # Sing-box
nimbus-proxy-d   # WireGuard
```

### Автоматическая установка

```bash
./install.sh
```

Скрипт должен:
1. Проверить системные требования
2. Определить CPU/RAM автоматически
3. Запросить только домен и email
4. Сгенерировать безопасный пароль админа
5. Создать первого пользователя автоматически
6. Сгенерировать все конфигурации
7. Запустить все сервисы
8. Дождаться получения SSL сертификатов
9. Проверить работоспособность
10. Вывести данные для доступа

## Задачи

### Этап 1: Рефакторинг структуры (Приоритет: Высокий)

- [ ] Переименовать директории (admin-panel → web, xray → proxy-a, и т.д.)
- [ ] Обновить docker-compose.yml с новыми именами
- [ ] Удалить префиксы "stealth-" везде
- [ ] Заменить "VPN" на нейтральные термины
- [ ] Обновить все импорты и пути

### Этап 2: Очистка кодовой базы (Приоритет: Высокий)

- [ ] Удалить все тестовые скрипты (test-*.py, *-test.sh)
- [ ] Удалить миграционные скрипты (migrate-*.sh, rollback-*.sh)
- [ ] Удалить избыточную документацию (оставить только README.md)
- [ ] Удалить неиспользуемые модули (update_manager.py, log_reader.py, system_monitor.py)
- [ ] Удалить deployment документы (DEPLOYMENT.md, MIGRATION_*.md, и т.д.)
- [ ] Объединить дублирующийся код

### Этап 3: Автоматизация установки (Приоритет: Критический)

- [ ] Создать новый install.sh с автоматической настройкой
- [ ] Добавить автоопределение CPU/RAM
- [ ] Реализовать автогенерацию .env файла
- [ ] Добавить автосоздание первого пользователя
- [ ] Реализовать автогенерацию всех конфигураций
- [ ] Добавить проверку готовности сервисов
- [ ] Добавить автоматическое ожидание SSL сертификатов

### Этап 4: Исправление багов (Приоритет: Критический)

- [ ] Исправить проблему с bcrypt хешами в .env
- [ ] Исправить CPU limits (автоопределение)
- [ ] Исправить права доступа (убрать user: директивы)
- [ ] Исправить пути к сертификатам
- [ ] Исправить DNS resolution для контейнеров
- [ ] Исправить проблемы с chown в entrypoint.sh

### Этап 5: Упрощение конфигураций (Приоритет: Средний)

- [ ] Минимизировать Caddyfile (только необходимое)
- [ ] Упростить docker-compose.yml
- [ ] Удалить неиспользуемые переменные окружения
- [ ] Упростить entrypoint.sh скрипты
- [ ] Удалить избыточные health checks

### Этап 6: Тестирование (Приоритет: Высокий)

- [ ] Тест на чистой системе Ubuntu 22.04
- [ ] Тест на single-core сервере
- [ ] Тест автоматической установки
- [ ] Тест создания пользователя
- [ ] Тест всех протоколов
- [ ] Тест SSL сертификатов
- [ ] Тест обновления системы

## Критерии успеха

### Обязательные

1. ✅ Установка одной командой без ручного вмешательства
2. ✅ Все сервисы запускаются и работают после установки
3. ✅ Первый пользователь создается автоматически
4. ✅ SSL сертификаты получаются автоматически
5. ✅ Нет упоминаний "VPN" в коде и конфигах
6. ✅ Нет префиксов "stealth-"
7. ✅ Кодовая база сокращена минимум на 50%

### Желательные

1. ✅ Время установки < 5 минут
2. ✅ Размер репозитория < 10 MB
3. ✅ Количество файлов < 50
4. ✅ Работает на 1 CPU / 1 GB RAM
5. ✅ Автоматическое обновление

## Риски и митигация

### Риск 1: Поломка существующих установок
**Митигация:** Создать отдельную ветку, тестировать на чистых серверах

### Риск 2: Потеря функциональности
**Митигация:** Документировать все удаляемые компоненты, создать checklist

### Риск 3: Проблемы с обратной совместимостью
**Митигация:** Создать скрипт миграции для существующих установок

### Риск 4: Сложность автоматизации
**Митигация:** Разбить на маленькие задачи, тестировать каждую отдельно

## Метрики

### До рефакторинга
- Файлов: ~150
- Строк кода: ~15,000
- Время установки: 30+ минут (с ручными правками)
- Упоминаний "VPN": ~500
- Упоминаний "stealth": ~200

### После рефакторинга (цель)
- Файлов: < 50
- Строк кода: < 5,000
- Время установки: < 5 минут (полностью автоматически)
- Упоминаний "VPN": 0
- Упоминаний "stealth": 0

## Приоритизация

### Фаза 1 (Неделя 1): Критические исправления
1. Автоматизация установки
2. Исправление багов развертывания
3. Автогенерация конфигураций

### Фаза 2 (Неделя 2): Рефакторинг
1. Переименование компонентов
2. Очистка кодовой базы
3. Упрощение конфигураций

### Фаза 3 (Неделя 3): Тестирование и документация
1. Комплексное тестирование
2. Обновление документации
3. Создание примеров

## Зависимости

- Docker 24.0+
- Docker Compose v2
- Ubuntu 22.04 / Debian 12
- Домен с DNS записями
- Порты 80, 443 открыты

## Результат

После выполнения спецификации получим:
- ✅ Чистую минималистичную кодовую базу
- ✅ Полностью автоматическое развертывание
- ✅ Нейтральную терминологию без упоминаний VPN
- ✅ Надежную работу на любом сервере
- ✅ Простоту поддержки и обновления
