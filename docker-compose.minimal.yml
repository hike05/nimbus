version: '3.8'

# Minimal deployment mode - Caddy + Admin Panel only
# Use this for initial deployment and troubleshooting
# To add VPN services later, use docker-compose.yml

services:
  caddy:
    image: caddy:2-alpine
    container_name: stealth-caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # For HTTP/3 QUIC support
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - ./data/www:/srv:ro
      - ./config/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./data/caddy/certificates:/etc/letsencrypt
    environment:
      - CADDY_ADMIN=0.0.0.0:2019
      - DOMAIN=${DOMAIN:-your-domain.com}
      - EMAIL=${EMAIL:-admin@your-domain.com}
    networks:
      - stealth-vpn
    restart: unless-stopped
    depends_on:
      admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /run:noexec,nosuid,nodev,size=10m
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 64M
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096

  admin:
    build:
      context: ./admin-panel
      dockerfile: Dockerfile
    image: stealth-admin:latest
    container_name: stealth-admin
    user: "1000:1000"
    volumes:
      - ./data/stealth-vpn:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For service management
      - admin_data:/var/lib/admin
    environment:
      - PYTHONPATH=/app:/app/core
      - FLASK_ENV=${FLASK_ENV:-production}
      - FLASK_APP=app.py
      - DATA_DIR=/app/data
      - DOMAIN=${DOMAIN:-your-domain.com}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH}
      - SESSION_SECRET=${SESSION_SECRET}
      - ADMIN_PANEL_PORT=${ADMIN_PANEL_PORT:-8010}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RATE_LIMIT_ADMIN=${RATE_LIMIT_ADMIN:-5}
    networks:
      - stealth-vpn
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8010/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /run:noexec,nosuid,nodev,size=10m
      - /app/.cache:noexec,nosuid,nodev,size=50m
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    ulimits:
      nofile:
        soft: 4096
        hard: 4096
      nproc:
        soft: 2048
        hard: 2048

networks:
  stealth-vpn:
    name: stealth-vpn
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

volumes:
  caddy_data:
    name: stealth-caddy-data
    driver: local
  caddy_config:
    name: stealth-caddy-config
    driver: local
  admin_data:
    name: stealth-admin-data
    driver: local
