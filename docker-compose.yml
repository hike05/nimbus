version: '3.8'

services:
  caddy:
    image: caddy:2-alpine
    container_name: gateway
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # For HTTP/3 QUIC support
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - ./data/www:/srv:ro
      - ./config/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./data/caddy/certificates:/etc/letsencrypt
    environment:
      - CADDY_ADMIN=0.0.0.0:2019
      - DOMAIN=${DOMAIN:-your-domain.com}
      - EMAIL=${EMAIL:-admin@your-domain.com}
    networks:
      - proxy-network
    restart: unless-stopped
    depends_on:
      admin:
        condition: service_healthy
      xray:
        condition: service_healthy
      trojan:
        condition: service_healthy
      singbox:
        condition: service_healthy
      wireguard:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /run:noexec,nosuid,nodev,size=10m
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT_PER_SERVICE:-0.5}'
          memory: ${RAM_LIMIT_PER_SERVICE:-256M}
        reservations:
          cpus: '0.1'
          memory: 64M
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096

  xray:
    build:
      context: ./xray
      dockerfile: Dockerfile
    image: proxy-a:latest
    container_name: proxy-a
    volumes:
      - ./data/proxy/configs:/etc/xray:ro
      - ./data/caddy/certificates:/etc/letsencrypt:ro
      - ./data/proxy/logs/xray:/var/log/xray
      - xray_data:/var/lib/xray
    environment:
      - XRAY_VISION_PORT=${XRAY_VISION_PORT:-8001}
      - XRAY_WEBSOCKET_PORT=${XRAY_WEBSOCKET_PORT:-8004}
      - DOMAIN=${DOMAIN:-your-domain.com}
    networks:
      - proxy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /etc/xray/xray.json && pgrep xray"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /run:noexec,nosuid,nodev,size=10m
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT_PER_SERVICE:-0.5}'
          memory: ${RAM_LIMIT_PER_SERVICE:-256M}
        reservations:
          cpus: '0.1'
          memory: 64M
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096

  trojan:
    build:
      context: ./trojan
      dockerfile: Dockerfile
    image: proxy-b:latest
    container_name: proxy-b
    volumes:
      - ./data/proxy/configs:/etc/trojan-go:ro
      - ./data/caddy/certificates:/etc/letsencrypt:ro
      - ./data/proxy/logs/trojan:/var/log/trojan-go
      - trojan_data:/var/lib/trojan-go
    environment:
      - CONFIG_FILE=/etc/trojan-go/trojan.json
      - TROJAN_PORT=${TROJAN_PORT:-8002}
      - DOMAIN=${DOMAIN:-your-domain.com}
    networks:
      - proxy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /etc/trojan-go/trojan.json && pgrep trojan-go"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /run:noexec,nosuid,nodev,size=10m
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT_PER_SERVICE:-0.5}'
          memory: ${RAM_LIMIT_PER_SERVICE:-256M}
        reservations:
          cpus: '0.1'
          memory: 64M
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096

  singbox:
    build:
      context: ./singbox
      dockerfile: Dockerfile
    image: proxy-c:latest
    container_name: proxy-c
    volumes:
      - ./data/proxy/configs:/etc/sing-box:ro
      - ./data/caddy/certificates:/etc/letsencrypt:ro
      - ./data/proxy/logs/singbox:/var/log/sing-box
      - singbox_data:/var/lib/sing-box
    environment:
      - SINGBOX_SHADOWTLS_PORT=${SINGBOX_SHADOWTLS_PORT:-8003}
      - SINGBOX_HYSTERIA_PORT=${SINGBOX_HYSTERIA_PORT:-8005}
      - SINGBOX_TUIC_PORT=${SINGBOX_TUIC_PORT:-8006}
      - DOMAIN=${DOMAIN:-your-domain.com}
    networks:
      - proxy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /etc/sing-box/singbox.json && pgrep sing-box"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /run:noexec,nosuid,nodev,size=10m
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT_PER_SERVICE:-0.5}'
          memory: ${RAM_LIMIT_PER_SERVICE:-256M}
        reservations:
          cpus: '0.1'
          memory: 64M
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096

  wireguard:
    build:
      context: ./wireguard
      dockerfile: Dockerfile
    image: proxy-d:latest
    container_name: proxy-d
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-UTC}
      - WG_PORT=${WIREGUARD_SERVER_PORT:-51820}
      - WG_ADDRESS=${PROXY_SUBNET:-10.66.66.1/24}
      - WG_DNS=${DNS_SERVERS:-1.1.1.1,8.8.8.8}
      - ENABLE_WEBSOCKET=true
      - ENABLE_UDP2RAW=false
      - WEBSOCKET_PORT=${WIREGUARD_WEBSOCKET_PORT:-8006}
      - UDP2RAW_PORT=8007
      - DOMAIN=${DOMAIN:-your-domain.com}
    volumes:
      - ./data/proxy/configs/wireguard:/config
      - ./data/caddy/certificates:/etc/letsencrypt:ro
      - ./data/proxy/logs/wireguard:/var/log/wireguard
      - /lib/modules:/lib/modules:ro
      - wireguard_data:/var/lib/wireguard
    networks:
      - proxy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "test -d /config && wg show wg0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT_PER_SERVICE:-0.5}'
          memory: ${RAM_LIMIT_PER_SERVICE:-256M}
        reservations:
          cpus: '0.1'
          memory: 64M
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096

  admin:
    build:
      context: ./admin-panel
      dockerfile: Dockerfile
    image: web:latest
    container_name: web
    user: "1000:1000"
    volumes:
      - ./data/proxy:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For service management
      - admin_data:/var/lib/admin
      - ./data/caddy/certificates:/data/caddy/certificates:ro  # For SSL cert backup
      - ./config/Caddyfile:/etc/caddy/Caddyfile:ro  # For Caddyfile backup
      - ./docker-compose.yml:/app/docker-compose.yml:ro  # For docker-compose backup
    environment:
      - PYTHONPATH=/app:/app/core
      - FLASK_ENV=${FLASK_ENV:-production}
      - FLASK_APP=app.py
      - DATA_DIR=/app/data
      - DOMAIN=${DOMAIN:-your-domain.com}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH}
      - SESSION_SECRET=${SESSION_SECRET}
      - ADMIN_PANEL_PORT=${ADMIN_PANEL_PORT:-8010}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RATE_LIMIT_ADMIN=${RATE_LIMIT_ADMIN:-5}
    networks:
      - proxy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8010/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /run:noexec,nosuid,nodev,size=10m
      - /app/.cache:noexec,nosuid,nodev,size=50m
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT_PER_SERVICE:-0.5}'
          memory: ${RAM_LIMIT_PER_SERVICE:-256M}
        reservations:
          cpus: '0.1'
          memory: 64M
    ulimits:
      nofile:
        soft: 4096
        hard: 4096
      nproc:
        soft: 2048
        hard: 2048

networks:
  proxy-network:
    name: proxy-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

volumes:
  caddy_data:
    name: gateway-data
    driver: local
  caddy_config:
    name: gateway-config
    driver: local
  xray_data:
    name: proxy-a-data
    driver: local
  trojan_data:
    name: proxy-b-data
    driver: local
  singbox_data:
    name: proxy-c-data
    driver: local
  wireguard_data:
    name: proxy-d-data
    driver: local
  admin_data:
    name: web-data
    driver: local